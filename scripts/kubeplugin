#!/bin/bash

# kubectl-ptop: Print current CPU and memory usage for pods in a Kubernetes namespace.
#
# Usage:
#   kubectl ptop [namespace]
#
# If no namespace is provided, defaults to "kube-system".
#
# Prerequisites:
#   - kubectl installed and configured
#   - Metrics Server running in the cluster

# Print usage information
usage() {
  echo "Usage: kubectl ptop [namespace]"
  echo "Print current CPU/Memory usage for all pods in the specified namespace (default: kube-system)."
  exit 1
}

# Check kubectl presence
if ! command -v kubectl >/dev/null 2>&1; then
  echo "kubectl is not installed or not in PATH."
  exit 1
fi

# Determine namespace (first argument, or kube-system)
NAMESPACE="${1:-kube-system}"

if ! kubectl top pods -n "$NAMESPACE" --no-headers &>/dev/null; then
  echo "‚ùå Unable to retrieve metrics. Ensure the Metrics Server is installed and running."
  echo "Install with:"
  echo "kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml"
  exit 2
fi

echo "Resource, Namespace, Name, CPU, Memory"

kubectl top pods -n "$NAMESPACE" --no-headers | while read -r line; do
  NAME=$(echo $line | awk '{print $1}')
  CPU=$(echo $line | awk '{print $2}')
  MEMORY=$(echo $line | awk '{print $3}')
  echo "Pod, $NAMESPACE, $NAME, $CPU, $MEMORY"
done
